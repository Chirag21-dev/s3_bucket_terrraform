pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                // Replace 'your-repo-url' and 'your-credentials-id' as needed
                checkout scm
            }
        }

        stage('Terraform Format & Validate') {
            steps {
                sh 'terraform fmt -check=true -recursive' // Check for formatting issues
                sh 'terraform init'
                sh 'terraform validate' // Built-in Terraform validation
            }
        }

        stage('TFLint Analysis') {
            steps {
                // Ensure tflint is installed and configured (e.g., via a .tflint.hcl file)
                sh 'tflint --init'
                sh 'tflint -f=checkstyle > tflint-report.xml' // Generates a report file
            }
        }

        stage('TFSec Security Scan') {
            steps {
                // Scans for security misconfigurations
                sh 'tfsec --format junit --out tfsec-report.xml .' // Generates a JUnit report
            }
        }

        stage('Terraform Plan') {
            steps {
                sh 'terraform plan -out=tfplan.binary'
            }
        }

        stage('Apply Infrastructure (Manual Approval)') {
            // Manual approval gate before applying to production
            input {
                message "Proceed with infrastructure application?"
                ok "Apply"
            }
            steps {
                sh 'terraform apply -auto-approve tfplan.binary'
            }
        }
    }
